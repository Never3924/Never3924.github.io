function getTileCoords(e,t,l){let n=parseInt(Math.floor((t+180)/360*(1<<l))),a=parseInt(Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*(1<<l)));return{z:l,x:n,y:a}}function getTile(e,t,l){return`https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/${e}/${t}/${l}.jpg`}function getTiles(e){let t=getTile(e.z,e.x-(Math.floor(3*Math.random())+2),e.y-(Math.floor(3*Math.random())+2)),l=getTile(e.z,e.x,e.y),n=getTile(e.z,e.x+(Math.floor(3*Math.random())+2),e.y+(Math.floor(3*Math.random())+2));return[{isAnswer:!1,url:t},{isAnswer:!0,url:l},{isAnswer:!1,url:n},]}const shuffleArray=e=>{let t=[...e],l=t.reduce((e,l,n)=>{let a=Math.floor(Math.random()*(n+1));return t[n]=t[a],t[a]=l,t});return l};function map_control_disable(e){e.dragging.disable(),e.touchZoom.disable(),e.scrollWheelZoom.disable(),e.doubleClickZoom.disable(),e.boxZoom.disable(),e.tapHold.disable(),e.keyboard.disable(),e.zoomControl.disable()}function answerSet(e,t){let l=document.createElement("div");l.classList.add("answer-inner");let n=document.createElement("label");n.htmlFor=`select${e}`;let a=document.createElement("img");a.src=t,a.alt=`選択肢${e}`,n.appendChild(a);let s=document.createElement("input");s.type="radio",s.id=`select${e}`,s.name="answer",l.appendChild(s),l.appendChild(n);let o=document.getElementsByClassName("answer")[e];o.appendChild(l)}function getLatLon(){var e=22.799999999999997*Math.random()-12.6,t=e<0?-157.5:61.5,l=5.5*Math.random();return[37.5+Math.abs(e)*Math.sin(t/180*Math.PI)+l*Math.sin(-30/180*Math.PI),136.5+Math.abs(e)*Math.cos(t/180*Math.PI)+l*Math.cos(-30/180*Math.PI)]}async function isLatLonAvailable(e){try{let t=await fetch(e[0]),l=await fetch(e[1]),n=await fetch(e[2]);if(t.ok&&l.ok&&n.ok)return!0}catch(a){}return!1}const stage={S1:12,S2:15,S3:18};document.addEventListener("DOMContentLoaded",onLoad);let map=null,zoomLevel=stage.S1,latlon=getLatLon(),answer=null,marker=null,id=null,hint=0,score=0;function getRadio(e){let t=Array.from(document.getElementsByName(e));return t.map(e=>e.checked?e.id:null).filter(e=>e)[0]}async function onLoad(){await setUp()}async function restart(){let e=document.getElementsByName("answer");for(let t=0;t<e.length;t++)e[t].disabled=!1;let l=document.getElementsByClassName("answer");for(let n=0;n<l.length;n++)l[n].innerHTML="";clearInterval(id),id=null,document.getElementsByClassName("answer_check")[0].classList.remove("answer_check"),document.getElementById("result").innerHTML="",map.remove(),map=null,document.getElementById("loading").classList.remove("invisible"),document.getElementById("loading").classList.add("visible"),document.getElementById("main").classList.add("invisible"),document.getElementById("main").classList.remove("visible"),await setUp()}async function getTiles_ok(){var e;let t=getLatLon(),l=t[0],n=t[1],a=getTileCoords(l,n,18),s=shuffleArray(getTiles(a)),o=await isLatLonAvailable(s.map(e=>e.url));return o?[l,n,18,s]:(await new Promise(e=>setTimeout(e,1e3)),getTiles_ok())}async function setUp(){let e=await getTiles_ok(),t=e[0],l=e[1],n=e[2],a=e[3];latlon=[t,l],answer=a,map_control_disable(map=L.map("map",{center:[t,l],zoom:zoomLevel})),L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg",{maxZoom:n,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html">出典: 国土地理院ウェブサイト</a>'}).addTo(map),L.marker([t,l]).addTo(map),document.getElementById("map").getElementsByClassName("leaflet-top leaflet-left")[0].childNodes.forEach(e=>e.remove()),answerSet(0,a[0].url),answerSet(1,a[1].url),answerSet(2,a[2].url),map._onResize(),document.getElementById("hint").addEventListener("click",onHintClick),document.getElementById("answer_check").addEventListener("click",onAnswerCheckClick),document.getElementsByClassName("answer")[0].getElementsByClassName("answer-inner")[0].querySelectorAll("input")[0].checked=!0,document.getElementById("loading").classList.add("invisible"),document.getElementById("loading").classList.remove("visible"),document.getElementById("main").classList.remove("invisible"),document.getElementById("main").classList.add("visible"),id=setInterval(()=>{map.panTo(L.latLng(latlon[0],latlon[1])),document.getElementById("score").querySelector("div").querySelectorAll("span")[0].innerText=score,document.getElementById("score").querySelector("div").querySelectorAll("span")[1].innerText=hint},10)}function onHintClick(){map.getZoom()+3<=stage.S3&&(map.setZoom(map.getZoom()+3),hint++)}const useGeolocationService=()=>{let e=async e=>{let n=await t(e);if(n)return l(n)},t=async e=>{let t=await fetch(`https://mreversegeocoder.gsi.go.jp/reverse-geocoder/LonLatToAddress?lat=${e.lat}&lon=${e.lon}`);if(!t.ok)return;let l=await t.json();return l.results?.muniCd},l=e=>{let t="0"===e.substring(0,1)?e.slice(1):e,l=MUNI_LIST.MUNI_ARRAY[t];if(l)return l.split(",")[0]};return{getPrefectureCodeFromLatLon:e}};async function onAnswerCheckClick(){let e=getRadio("answer").slice(6),t=document.getElementById("result");t.innerHTML="";let l=answer.map(e=>e.isAnswer?answer.indexOf(e)+1:null).filter(e=>e)[0]-1;if(document.getElementsByClassName("answer")[l].classList.add("answer_check"),answer[parseInt(e)].isAnswer){let n=document.createElement("p");n.textContent="正解!",n.classList.add("ok"),t.appendChild(n),score++}else{let a=document.createElement("p");a.textContent="不正解...",a.classList.add("error"),t.appendChild(a),score--}let s=document.createElement("a");s.textContent="Google Map",s.href=`https://google.com/maps/search/${latlon[0]},${latlon[1]}/@${latlon[0]},${latlon[1]},8z`,t.appendChild(s);let o=document.getElementsByName("answer");for(let r=0;r<o.length;r++)o[r].disabled=!0;let i=document.createElement("button");i.classList.add("btn"),i.textContent="次に進む →",i.id="next",t.appendChild(i),document.getElementById("next").addEventListener("click",restart)}